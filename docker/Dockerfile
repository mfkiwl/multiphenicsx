# Copyright (C) 2016-2021 by the multiphenics authors
#
# This file is part of multiphenics.
#
# SPDX-License-Identifier: LGPL-3.0-or-later

FROM dolfinx/dev-env
MAINTAINER Francesco Ballarin <francesco.ballarin@sissa.it>

# Install FIAT, UFL and FFCX (development versions, master branch)
RUN pip3 install --no-cache-dir git+https://github.com/FEniCS/fiat.git && \
    pip3 install --no-cache-dir git+https://github.com/FEniCS/ufl.git && \
    pip3 install --no-cache-dir git+https://github.com/FEniCS/ffcx.git

# Clone and install dolfinx from fork
WORKDIR /root

RUN git config --global user.name "GitLab CI" && \
    git config --global user.email "multiphenics@gitlab.ci" && \
    git clone https://github.com/fenics/dolfinx.git && \
    cd dolfinx && \
    git remote add fork https://github.com/francesco-ballarin/dolfinx.git && \
    git fetch origin && \
    git fetch fork && \
    git checkout -b gitlab_ci && \
    git merge fork/migration

WORKDIR /tmp

ENV PETSC_ARCH "linux-gnu-real-32"

RUN mkdir build && \
    cd build && \
    cmake -G Ninja $HOME/dolfinx/cpp && \
    ninja install && \
    cd .. && \
    rm -rf /tmp/build

RUN cp -rf $HOME/dolfinx/python . && \
    cd python && \
    pip3 install . && \
    cd .. && \
    rm -rf /tmp/python

# Add former multiphenics dependencies
RUN apt-get -qq update && \
    apt-get -qq remove python3-pytest && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    pip3 -q install --upgrade nbconvert pytest pytest-flake8 pytest-html pytest-instafail pytest-xdist && \
    sed -i "s/pytest_report_header/DISABLED_pytest_report_header/g" /usr/local/lib/python3.8/dist-packages/pytest_metadata/plugin.py && \
    cat /dev/null > $FENICS_HOME/WELCOME

# Copy multiphenics clone
COPY . /root/multiphenics

WORKDIR /root
